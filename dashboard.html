<!DOCTYPE html>
<html lang="en">

<head>
  <title>CRASH DETEKTOR</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- CDN Links -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class', // Enable class-based dark mode
      theme: {
        extend: {
          fontFamily: {
            montserrat: ['Montserrat', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style/style.css" />
</head>

<body
  class="max-w-screen-lg mx-auto flex flex-col min-h-screen text-gray-700 bg-gray-50 dark:bg-[#1d1d1d] dark:text-white transition-colors duration-300">
  <!-- HEADER -->
  <div class="mt-2 md:mt-5 mx-6 flex items-start justify-between">
    <div class="text-center">
      <a href="user.html"
        class="fa fa-user-circle text-3xl cursor-pointer hover:text-gray-900 dark:hover:text-gray-300 transition-colors"></a>
    </div>

    <div class="flex flex-col items-center">
      <a href="" class="text-center">
        <span class="text-2xl font-extrabold tracking-widest text-gray-800 dark:text-white">IMPACT CRASH ALERT</span>
      </a>
      <!-- Connection Indicator -->
      <div id="connection-status"
        class="flex items-center gap-2 mt-1 px-3 py-1 rounded-full bg-red-100 dark:bg-red-900/30 transition-colors duration-300">
        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
        <span class="text-[10px] font-bold text-red-600 dark:text-red-400 uppercase tracking-wider">Disconnected</span>
      </div>
    </div>

    <i id="dark-mode-toggle"
      class="fa fa-moon text-3xl cursor-pointer icon-transition hover:text-gray-900 dark:hover:text-gray-300"></i>
  </div>
  <div class="text-xs font-semibold flex items-center justify-center text-gray-400 mb-6 mt-4">By FIKRI ALI</div>

  <!-- CRASH STATUS BANNER -->
  <div class="mx-6 mb-6">
    <div id="crash-badge"
      class="flex items-center justify-center gap-3 bg-green-100 dark:bg-green-900/30 p-4 rounded-2xl shadow-sm border border-green-200 dark:border-green-800 transition-all duration-300">
      <div class="p-2 bg-green-500 rounded-full text-white">
        <i id="crash-icon" class="fas fa-shield-alt text-lg"></i>
      </div>
      <div class="flex flex-col">
        <span class="text-xs font-bold text-green-600 dark:text-green-400 uppercase tracking-widest">Status</span>
        <span id="crash-text" class="text-lg font-extrabold text-green-700 dark:text-green-300">AMAN</span>
      </div>
    </div>
  </div>

  <!-- SENSOR -->
  <div class="flex-1 flex flex-col justify-center mx-5 mb-10">
    <div class="grid grid-cols-2 gap-5">
      <!-- Pitch (Kemiringan Depan/Belakang) -->
      <div
        class="grid items-center text-center bg-gray-200 dark:bg-[#333] rounded-3xl py-8 shadow-sm hover:shadow-md transition-all">
        <i class="fas fa-plane-up fa-3x text-green-600 transform -rotate-12"></i>
        <div class="flex items-center justify-center mt-5 mb-3">
          <span class="mr-1 text-3xl font-extrabold dark:text-white" id="sensor3">-</span>
          <span class="text-xl font-semibold dark:text-gray-300">Â°</span>
        </div>
        <span class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2">Kemiringan
          Depan</span>
        <div id="status-pitch" class="text-xs font-bold text-gray-400 dark:text-gray-500 italic">Menunggu Data...</div>
      </div>

      <!-- Roll (Kemiringan Kiri/Kanan) -->
      <div
        class="grid items-center text-center bg-gray-200 dark:bg-[#333] rounded-3xl py-8 shadow-sm hover:shadow-md transition-all">
        <i class="fas fa-rotate fa-3x text-purple-600"></i>
        <div class="flex items-center justify-center mt-5 mb-3">
          <span class="mr-1 text-3xl font-extrabold dark:text-white" id="sensor4">-</span>
          <span class="text-xl font-semibold dark:text-gray-300">Â°</span>
        </div>
        <span class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2">Kemiringan
          Samping</span>
        <div id="status-roll" class="text-xs font-bold text-gray-400 dark:text-gray-500 italic">Menunggu Data...</div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="mx-6 flex justify-center items-center mt-auto">
    <i class="fa fa-location-arrow text-left text-xl text-blue-500"></i>
    <span class="ml-2 text-center text-sm font-bold text-gray-600 dark:text-gray-300" id="location">Mendeteksi
      lokasi...</span>
  </div>
  <div class="mb-10 mx-6 flex flex-col justify-center items-center mt-2 text-gray-400 space-y-2">
    <div class="flex items-center">
      <span class="text-center text-xs">Last update :</span>
      <span class="ml-1 text-center text-xs font-mono" id="timestamp">-</span>
    </div>
    <!-- DEBUG DISPLAY -->
    <div class="bg-black/10 dark:bg-white/10 px-4 py-2 rounded-lg" id="debug-container">
      <span id="debug-data" class="text-[10px] font-mono text-gray-500 dark:text-gray-400">Waiting for Raw
        Data...</span>
    </div>
  </div>

  <!-- MQTT & Logic -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <script>
    // Theme Toggler
    const toggleButton = document.getElementById('dark-mode-toggle');
    const bodyCurrent = document.documentElement; // Tailwind 'class' mode usually works best on html tag, but body is fine if configured.
    // However, tailwind documentation says add 'dark' class to html or body. Standard is html.

    // Function to apply theme
    function applyTheme(isDark) {
      if (isDark) {
        bodyCurrent.classList.add('dark');
        // Legacy support if style.css is still used for some things
        document.body.classList.add('dark-mode');
        toggleButton.classList.remove('fa-moon');
        toggleButton.classList.add('fa-sun');
      } else {
        bodyCurrent.classList.remove('dark');
        document.body.classList.remove('dark-mode');
        toggleButton.classList.remove('fa-sun');
        toggleButton.classList.add('fa-moon');
      }
    }

    // Check local storage
    if (localStorage.getItem('theme') === 'dark') {
      applyTheme(true);
    }

    toggleButton.addEventListener('click', () => {
      const isDark = !bodyCurrent.classList.contains('dark');
      applyTheme(isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // MQTT Setup
    console.log("Connecting to MQTT...");

    const updateConnectionStatus = (status) => {
      const el = document.getElementById('connection-status');
      const dot = el.querySelector('span:first-child');
      const text = el.querySelector('span:last-child');

      if (status === 'connected') {
        el.className = "flex items-center gap-2 mt-1 px-3 py-1 rounded-full bg-green-100 dark:bg-green-900/30 transition-colors duration-300";
        dot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
        text.className = "text-[10px] font-bold text-green-600 dark:text-green-400 uppercase tracking-wider";
        text.innerText = "Connected";
      } else {
        el.className = "flex items-center gap-2 mt-1 px-3 py-1 rounded-full bg-red-100 dark:bg-red-900/30 transition-colors duration-300";
        dot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
        text.className = "text-[10px] font-bold text-red-600 dark:text-red-400 uppercase tracking-wider";
        text.innerText = "Disconnected";
      }
    };

    const updateCrashStatus = (status) => {
      const badge = document.getElementById('crash-badge');
      const iconContainer = badge.querySelector('div:first-child');
      const icon = document.getElementById('crash-icon');
      const text = document.getElementById('crash-text');
      const label = badge.querySelector('span:first-child');

      if (status === 'CRASH') {
        // Danger State
        badge.className = "flex items-center justify-center gap-3 bg-red-100 dark:bg-red-900/30 p-4 rounded-2xl shadow-md border border-red-200 dark:border-red-800 transition-all duration-300 scale-105";
        iconContainer.className = "p-2 bg-red-500 rounded-full text-white animate-bounce";
        icon.className = "fas fa-exclamation-triangle text-lg";
        text.className = "text-lg font-extrabold text-red-700 dark:text-red-300";
        text.innerText = "KECELAKAAN!";
        label.className = "text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-widest";

        // SweetAlert Warning
        Swal.fire({
          icon: 'warning',
          title: 'KECELAKAAN TERDETEKSI!',
          text: 'Segera periksa kondisi perangkat!',
          timer: 3000,
          showConfirmButton: false,
          background: document.documentElement.classList.contains('dark') ? '#1f1f1f' : '#fff',
          color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
        });

      } else {
        // Safe State
        badge.className = "flex items-center justify-center gap-3 bg-green-100 dark:bg-green-900/30 p-4 rounded-2xl shadow-sm border border-green-200 dark:border-green-800 transition-all duration-300";
        iconContainer.className = "p-2 bg-green-500 rounded-full text-white";
        icon.className = "fas fa-shield-alt text-lg";
        text.className = "text-lg font-extrabold text-green-700 dark:text-green-300";
        text.innerText = "AMAN";
        label.className = "text-xs font-bold text-green-600 dark:text-green-400 uppercase tracking-widest";
      }
    };

    // Variabel Timer untuk monitoring data
    let connectionTimeout;

    const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt", {
      clientId: "web_" + Math.random().toString(16).substr(2, 8),
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 4000,
    });

    client.on("connect", () => {
      console.log("âœ… Terhubung ke broker MQTT (Menunggu Data...)");
      // KITA JANGAN LANGSUNG SET CONNECTED. TUNGGU DATA MASUK DULU.
      // updateConnectionStatus('connected'); 

      // PERBAIKAN: Gunakan topik yang SAMA PERSIS dengan Arduino
      const topic = "proyek/skripsi/IMK-FIKRI";

      client.subscribe(topic, (err) => {
        if (err) console.error("âŒ Gagal subscribe:", err);
        else console.log("ðŸ“¡ Subscribed to " + topic);
      });
    });

    // Add Error Handling
    client.on("error", (error) => {
      console.error("MQTT Error:", error);
      updateConnectionStatus('disconnected');
    });

    client.on("message", (topic, message) => {
      try {
        const payload = message.toString();
        const data = JSON.parse(payload);

        // DEBUG: Lihat data yang masuk di Console Browser (Tekan F12)
        console.log("Data Masuk:", data);

        // 1. CEK APAKAH DATA VALID (Bisa dibaca angka)
        const isDataValid = (data.pitch !== undefined && data.pitch !== null) &&
          (data.roll !== undefined && data.roll !== null);

        if (isDataValid) {
          // JIKA DATA TERBACA VALID:
          // 1. Set Status CONNECTED (Hijau)
          updateConnectionStatus('connected');

          // 2. Clear Timer sebelumnya
          clearTimeout(connectionTimeout);

          // 3. Pasang Timer baru: Jika 4 detik tidak ada data lagi, set DISCONNECTED
          connectionTimeout = setTimeout(() => {
            console.warn("âš ï¸ Data timeout (tidak ada data baru > 4 detik)");
            updateConnectionStatus('disconnected');
          }, 4000); // 4 detik toleransi

          // Update Pitch & Roll (Akan bergerak realtime sekarang)
          const pitch = parseFloat(data.pitch);
          const roll = parseFloat(data.roll);

          console.log(`Parsed Data -> Pitch: ${pitch}, Roll: ${roll}`);

          // UPDATE DEBUG DISPLAY
          document.getElementById("debug-data").textContent = `RAW: Pitch=${pitch} | Roll=${roll}`;

          if (!isNaN(pitch)) document.getElementById("sensor3").textContent = pitch.toFixed(2);
          if (!isNaN(roll)) document.getElementById("sensor4").textContent = roll.toFixed(2);
          document.getElementById("timestamp").textContent = new Date().toLocaleString();

          // --- NEW: Keterangan Status Text ---
          const statusPitchEl = document.getElementById("status-pitch");
          const statusRollEl = document.getElementById("status-roll");

          let statusPitchText = "Motor Normal";
          let statusRollText = "Motor Normal";
          let pitchColor = "text-gray-400 dark:text-gray-500";
          let rollColor = "text-gray-400 dark:text-gray-500";

          // Logic Pitch (Jamping) - Threshold 15 degrees
          if (pitch > 15) {
            statusPitchText = "Motor Jamping Depan";
            pitchColor = "text-orange-500 font-extrabold";
          } else if (pitch < -15) {
            statusPitchText = "Motor Jamping Belakang";
            pitchColor = "text-orange-500 font-extrabold";
          }

          // Logic Roll (Miring) - Threshold 15 degrees
          if (roll > 15) {
            statusRollText = "Motor Miring Kanan";
            rollColor = "text-orange-500 font-extrabold";
          } else if (roll < -15) {
            statusRollText = "Motor Miring Kiri";
            rollColor = "text-orange-500 font-extrabold";
          }

          // Jika Kecelakaan detected by hardware
          if (data.status === "CRASH") {
            statusPitchText = "KECELAKAAN! " + statusPitchText;
            statusRollText = "KECELAKAAN! " + statusRollText;
            pitchColor = "text-red-600 dark:text-red-500 font-extrabold animate-pulse";
            rollColor = "text-red-600 dark:text-red-500 font-extrabold animate-pulse";
          }

          statusPitchEl.textContent = statusPitchText;
          statusPitchEl.className = "text-xs font-bold italic " + pitchColor;

          statusRollEl.textContent = statusRollText;
          statusRollEl.className = "text-xs font-bold italic " + rollColor;
          // -----------------------------------
        }

        // Update Status Warna/Alert jika CRASH (Status tetap diproses walau data numeric invalid, untuk safety)
        if (data.status) {
          updateCrashStatus(data.status);

          if (data.status === "CRASH") {
            Swal.fire({
              title: 'KECELAKAAN TERDETEKSI!',
              text: 'Lokasi dan kondisi pengendara bahaya.',
              icon: 'warning',
              confirmButtonText: 'OK'
            });
          }
        }

      } catch (e) {
        console.error("Gagal parsing JSON:", e);
      }
    });

    // Location with Fallback
    function updateLocation(enableHighAccuracy = true) {
      if (navigator.geolocation) {
        const locationEl = document.getElementById('location');
        if (enableHighAccuracy) locationEl.textContent = "Mencari lokasi (GPS)...";

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            try {
              // GANTI NOMINATIM DENGAN BigDataCloud (CORS Friendly)
              const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=id`);
              const data = await response.json();

              // BigDataCloud structure: city, locality, principalSubdivision
              let locationText = data.city || data.locality || data.principalSubdivision || data.countryName;
              locationEl.textContent = locationText || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;

            } catch (error) {
              console.error("Fetch error:", error);
              // Fallback to coordinates
              locationEl.textContent = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
            }
          },
          (error) => {
            console.warn("Geolocation Error (HighAcc=" + enableHighAccuracy + "):", error);

            // FALLBACK: Jika Timeout/Error pakai HighAccuracy, coba LowAccuracy (jaringan/wifi)
            if (enableHighAccuracy && (error.code === error.TIMEOUT || error.code === error.POSITION_UNAVAILABLE)) {
              document.getElementById('location').textContent = "Mencoba sinyal seluler...";
              updateLocation(false); // <--- Recursive call with low accuracy
              return;
            }

            let msg = "Lokasi tidak tersedia";
            switch (error.code) {
              case error.PERMISSION_DENIED:
                msg = "Izin Lokasi Ditolak";
                break;
              case error.POSITION_UNAVAILABLE:
                msg = "Sinyal GPS Hilang";
                break;
              case error.TIMEOUT:
                msg = "Waktu Habis (Cek GPS)";
                break;
              default:
                msg = "Error Lokasi: " + error.message;
            }
            document.getElementById('location').textContent = msg;
          },
          { enableHighAccuracy: enableHighAccuracy, timeout: 5000, maximumAge: 0 }
        );
      } else {
        document.getElementById('location').textContent = "Browser tidak dukung GPS";
      }
    }
    // Update location every 1 minute
    updateLocation();
    setInterval(() => updateLocation(true), 60000);
  </script>
</body>

</html>